<?xml version="1.0" encoding="UTF-8"?>
<build-type xmlns="https://www.jetbrains.com/teamcity/schemas/2020.1" 
           uuid="POC3_Build_NodeJS_React" 
           name="Build - Node.js React App" 
           description="Build and test Node.js/React hello world application">

  <settings>
    <parameters>
      <param name="env.APP_NAME" value="nodejs-react" />
      <param name="env.APP_PORT" value="3000" />
      <param name="env.DOCKER_IMAGE" value="%env.ECR_REGISTRY%/poc3-nodejs-react" />
      <param name="env.NODE_VERSION" value="18" />
    </parameters>

    <build-runners>
      <!-- Checkout and Setup -->
      <runner id="CHECKOUT" name="Checkout Code" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            echo "=== Node.js/React Application Build ==="
            echo "Working directory: $(pwd)"
            echo "Node.js version: $(node --version)"
            echo "NPM version: $(npm --version)"
            
            cd poc3/applications/nodejs-react
            echo "Application directory: $(pwd)"
            ls -la
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Install Dependencies -->
      <runner id="INSTALL" name="Install Dependencies" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Installing NPM dependencies..."
            npm ci --no-audit --prefer-offline
            
            echo "Dependencies installed successfully"
            npm list --depth=0
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Code Quality and Linting -->
      <runner id="LINT" name="Code Quality Check" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Running ESLint..."
            npm run lint || echo "Linting completed with warnings"
            
            echo "Running security audit..."
            npm audit --audit-level moderate
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Unit Tests -->
      <runner id="TEST" name="Unit Tests" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Running unit tests..."
            npm test -- --coverage --watchAll=false --ci
            
            echo "Test results:"
            cat coverage/lcov-report/index.html | grep -o 'coverage.*%' || echo "Coverage report generated"
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Build Application -->
      <runner id="BUILD" name="Build Application" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Building application..."
            npm run build
            
            echo "Build completed successfully"
            ls -la
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Docker Build -->
      <runner id="DOCKER_BUILD" name="Docker Build" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Building Docker image..."
            docker build -t %env.DOCKER_IMAGE%:latest -t %env.DOCKER_IMAGE%:%build.number% .
            
            echo "Docker image built successfully"
            docker images | grep poc3-nodejs-react
            
            # Run security scan on image
            echo "Running container security scan..."
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              -v $(pwd):/tmp/scan aquasec/trivy:latest image \
              --format json --output /tmp/scan/trivy-report.json \
              %env.DOCKER_IMAGE%:latest
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Integration Tests -->
      <runner id="INTEGRATION_TEST" name="Integration Tests" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Starting application for integration tests..."
            docker run -d --name test-app -p %env.APP_PORT%:%env.APP_PORT% %env.DOCKER_IMAGE%:latest
            
            # Wait for application to start
            sleep 10
            
            echo "Running integration tests..."
            curl -f http://localhost:%env.APP_PORT%/health || exit 1
            curl -f http://localhost:%env.APP_PORT%/api/hello || exit 1
            curl -f http://localhost:%env.APP_PORT%/api/info || exit 1
            
            echo "Integration tests passed"
            
            # Cleanup
            docker stop test-app
            docker rm test-app
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Push to ECR -->
      <runner id="PUSH_ECR" name="Push to ECR" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Authenticating with ECR..."
            aws ecr get-login-password --region %env.AWS_REGION% | docker login --username AWS --password-stdin %env.ECR_REGISTRY%
            
            # Create repository if it doesn't exist
            aws ecr describe-repositories --repository-names poc3-nodejs-react --region %env.AWS_REGION% || \
            aws ecr create-repository --repository-name poc3-nodejs-react --region %env.AWS_REGION%
            
            echo "Pushing Docker image to ECR..."
            docker push %env.DOCKER_IMAGE%:latest
            docker push %env.DOCKER_IMAGE%:%build.number%
            
            echo "Image pushed successfully to ECR"
            ]]>
          </param>
        </parameters>
      </runner>

      <!-- Publish Artifacts -->
      <runner id="PUBLISH" name="Publish Artifacts" type="simpleRunner">
        <parameters>
          <param name="script.content">
            <![CDATA[
            cd poc3/applications/nodejs-react
            
            echo "Publishing artifacts to JFrog..."
            
            # Create artifact package
            tar -czf poc3-nodejs-react-%build.number%.tar.gz \
              package.json server.js public/ Dockerfile
            
            # Upload to JFrog (if configured)
            if [ ! -z "%env.JFROG_URL%" ]; then
              curl -u %jfrog.username%:%jfrog.password% \
                -T poc3-nodejs-react-%build.number%.tar.gz \
                "%env.JFROG_URL%/artifactory/poc3-generic/nodejs-react/poc3-nodejs-react-%build.number%.tar.gz"
            fi
            
            echo "Artifacts published successfully"
            ]]>
          </param>
        </parameters>
      </runner>
    </build-runners>

    <vcs-settings>
      <vcs-entry-ref root-id="POC3_GitHubVcsRoot" />
    </vcs-settings>

    <triggers>
      <trigger id="VCS_TRIGGER" type="vcsTrigger">
        <parameters>
          <param name="enableQueueOptimization" value="true" />
          <param name="quietPeriodMode" value="DO_NOT_USE" />
        </parameters>
      </trigger>
    </triggers>

    <features>
      <feature id="perfmon" type="perfmon" />
      <feature id="dockerSupport" type="DockerSupport">
        <parameters>
          <param name="dockerImagePlatform" value="linux" />
        </parameters>
      </feature>
    </features>

    <dependencies>
      <dependency id="SECURITY_DEP" type="snapshot_dependency">
        <settings>
          <param name="run-build-if-dependency-failed" value="false" />
          <param name="take-started-build-with-same-revisions" value="true" />
          <param name="take-successful-snapshots-only" value="true" />
        </settings>
      </dependency>
    </dependencies>

    <cleanup />
  </settings>

  <requirements>
    <requirement id="RQ_NODE" type="equals">
      <param name="property-name" value="system.node.version" />
      <param name="property-value" value="%env.NODE_VERSION%" />
    </requirement>
    <requirement id="RQ_DOCKER" type="exists">
      <param name="property-name" value="docker.server.version" />
    </requirement>
  </requirements>

</build-type>